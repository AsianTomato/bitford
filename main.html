<!DOCTYPE html>
<html ng-app="Bitford" ng-csp>
  <head>
    <meta charset="utf-8">
    <title>Bitford</title>
    <script src="angular.js"></script>
    <script src="base64.js"></script>
    <script src="mime.js"></script>
    <script src="app.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>

  <body>
    <h1>Bitford</h1>

    <form ng-controller="MainController">
      <button ng-click="loadFile()">Load Torrent</button>
      <p style="display: inline-block; margin-left: 2em">
	<label>
	  Up:
	  <input ng-model="upShaper"
		 ng-change="changeShapers()"
		 size="6">
	    KB/s
	</label>
      </p>
      <p style="display: inline-block; margin-left: 2em">
	<label>
	  Down:
	  <input ng-model="downShaper"
		 ng-change="changeShapers()"
		 size="6">
	    KB/s
	</label>
      </p>
    </form>

    <section ng-controller="TorrentsController">
      <article ng-repeat="torrent in torrents"
	       ng-controller="TorrentController"
	       class="torrent">
	<h2 ng-click="toggleShow()">{{torrent.name}}</h2>
	<p class="size">
	  {{torrent.store.getDonePercent()}}%
	  of {{humanSize(torrent.store.size)}}
	  at {{humanSize(torrent.downRate.getRate())}}/s
	</p>
	<div ng-show="show">
	  <div>
	    <button ng-hide="isMultiFile" ng-click="saveButton([torrent.name])" ng-disabled="saving">Save</button>
	    <button ng-hide="isMultiFile || !canPlay(torrent.name)"
		    ng-click="playButton([torrent.name])">Play</button>
	    <button ng-click="removeButton()">Remove</button>
	  </div>
	  <ul class="files" ng-show="isMultiFile">
	    <li ng-repeat="file in torrent.files">
	      <h3>{{file.path.join("/")}}</h3>
	      <p class="size">{{humanSize(file.size)}}</p>
	      <button ng-click="saveButton(file.path)" ng-disabled="saving">Save</button>
	      <button ng-show="canPlay(file.path)"
		      ng-click="playButton(file.path)">Play</button>
	    </li>
	  </ul>

	  <div ng-show="videoURL || audioURL" class="video-container">
	    <video ng-show="videoURL"
	           controls autoplay
		   src="{{videoURL}}">
	    </video>
	    <audio ng-show="audioURL"
	           controls autoplay
		   src="{{audioURL}}">
	    </audio>
	  </div>

	  <div class="pieces-container">
	    <div class="pieces-scroll">
	      <canvas pieces-canvas
		      width="128" height="512" class="pieces">
	      </canvas>
	    </div>
	    <p class="pieces-legend">
	      <span style="background-color: #ccc"> </span>
	      missing
	      <span style="background-color: red"> </span>
	      requested
	      <span style="background-color: yellow"> </span>
	      received
	      <span style="background-color: blue"> </span>
	      stored
	      <span style="background-color: #0c0"> </span>
	      checked
	      <span style="background-color: #3f3"> </span>
	      valid
	    </p>
	  </div>
	  <table ng-show="torrent.peers.length > 0"
		 class="peers">
	    <thead>
	      <tr>
		<th>Address</th>
		<th>Client</th>
		<th>State</th>
		<th>Done</th>
		<th>Up</th>
		<th>Down</th>
		<th>Queue</th>
	      </tr>
	    </thead>
	    <tbody>
	      <tr ng-repeat="peer in torrent.peers"
		  ng-show="peer.state == 'connected'">
		<td>
		  <span ng-show="peer.direction == 'incoming'" title="Incoming">From</span>
		  <span ng-show="peer.direction == 'outgoing'" title="Outgoing">To</span>
		  {{peer.ip}}:{{peer.port}}
		</td>
		<td>{{peerIdToClient(peer.peerId)}}</td>
		<td ng-switch="peer.state">
		  <span ng-switch-when="connected">
		    <span ng-show="peer.choked" style="color: red">C</span>
		    <span ng-hide="peer.choked" style="color: green">U</span>
		    <span ng-show="peer.interested" style="color: blue">I</span>
		    <span ng-hide="peer.interested" style="color: #ccc">N</span>
		    <span ng-show="peer.interesting" style="color: blue">I!</span>
		    <span ng-hide="peer.interesting" style="color: #ccc">N!</span>
		  </span>
		  <span ng-switch-default>
		    {{peer.state}}<span ng-show="peer.error">: {{peer.error}}</span>
		  </span>
		</td>
		<td>{{peer.getDonePercent()}}%</td>
		<td>{{humanSize(peer.upRate.getRate())}}/s</td>
		<td>{{humanSize(peer.downRate.getRate())}}/s</td>
		<td>{{peer.requestedChunks.length}}↓ {{peer.pendingChunks.length}}↑</td>
	      </tr>
	    </tbody>
	  </table>
	</div>

      </article>
    </section>
  </body>
</html>
